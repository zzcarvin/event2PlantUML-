# 这个 workflow 在当前仓库里生效。
# 当 common-events-example 里的事件结构（Go 文件）有变更时：
# 1. 运行你的 Go 生成脚本
# 2. 把生成的 PlantUML 文档提交回当前仓库（使用仓库 Secret GH_PAT）

name: Generate Event Docs

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'common-events-example/events/**/*.go'
      - 'event-sync-automation/common-events-example/events/**/*.go'

jobs:
  generate-and-commit-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # 使用仓库 Secret GH_PAT，避免直接把 PAT 写进仓库
          token: ${{ secrets.GH_PAT }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Generate PlantUML docs
        run: |
          # 找到 generate-plantuml.go 的位置（兼容两种目录结构）
          if [ -f "./scripts/generate-plantuml.go" ]; then
            GEN_SCRIPT="./scripts/generate-plantuml.go"
          elif [ -f "./event-sync-automation/scripts/generate-plantuml.go" ]; then
            GEN_SCRIPT="./event-sync-automation/scripts/generate-plantuml.go"
          else
            echo "generate-plantuml.go not found in ./scripts or ./event-sync-automation/scripts"
            exit 1
          fi

          # 为仓库根目录下的 common-events-example 生成文档（如果存在）
          if [ -d "./common-events-example/events" ]; then
            go run "$GEN_SCRIPT" \
              -input ./common-events-example/events \
              -output ./output/event-structures-common.plantuml
          fi

          # 为 event-sync-automation 里的 common-events-example 生成文档（如果存在）
          if [ -d "./event-sync-automation/common-events-example/events" ]; then
            go run "$GEN_SCRIPT" \
              -input ./event-sync-automation/common-events-example/events \
              -output ./output/event-structures-sync.plantuml
          fi

      - name: Commit and push changes (if any)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if [ -n "$(git status --porcelain)" ]; then
            git add output/*.plantuml
            git commit -m "Update event structures docs [skip ci]"
            git push
          else
            echo "No changes to commit"
          fi


